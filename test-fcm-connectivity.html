<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conectividade FCM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Conectividade FCM</h1>
        <p>Este teste verifica se o navegador consegue se conectar ao servi√ßo de push do Google (FCM).</p>

        <div id="status" class="status info">
            Pronto para testar...
        </div>

        <div>
            <button onclick="testBrowserSupport()">1. Verificar Suporte</button>
            <button onclick="testFCMConnectivity()">2. Testar Conectividade FCM</button>
            <button onclick="testDifferentKey()">3. Testar com Chave Diferente</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#00ff00';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        async function testBrowserSupport() {
            log('üîç Testando suporte do navegador...', 'info');

            const tests = {
                'ServiceWorker': 'serviceWorker' in navigator,
                'PushManager': 'PushManager' in window,
                'Notification': 'Notification' in window,
                'HTTPS ou localhost': location.protocol === 'https:' || location.hostname === 'localhost'
            };

            for (const [name, result] of Object.entries(tests)) {
                if (result) {
                    log(`‚úÖ ${name}: Suportado`, 'success');
                } else {
                    log(`‚ùå ${name}: N√ÉO suportado`, 'error');
                }
            }

            log(`üìä Navegador: ${navigator.userAgent}`, 'info');
            log(`üåê URL: ${location.href}`, 'info');
            log(`üîí Protocolo: ${location.protocol}`, 'info');

            const allSupported = Object.values(tests).every(v => v);
            if (allSupported) {
                updateStatus('‚úÖ Navegador totalmente compat√≠vel!', 'success');
            } else {
                updateStatus('‚ùå Navegador N√ÉO √© compat√≠vel', 'error');
            }
        }

        async function testFCMConnectivity() {
            log('üåê Testando conectividade com FCM...', 'info');

            try {
                // Testar conex√£o com FCM
                log('üì° Tentando conectar a fcm.googleapis.com...', 'info');

                const response = await fetch('https://fcm.googleapis.com', {
                    mode: 'no-cors' // FCM n√£o permite CORS, mas podemos detectar se est√° acess√≠vel
                });

                log('‚úÖ Conseguiu fazer requisi√ß√£o ao FCM (status: opaque)', 'success');
                log('   Isso significa que o servidor FCM est√° acess√≠vel', 'info');
                updateStatus('‚úÖ FCM est√° acess√≠vel!', 'success');

            } catch (error) {
                log(`‚ùå Erro ao conectar com FCM: ${error.message}`, 'error');
                log('   Poss√≠veis causas:', 'error');
                log('   - Firewall bloqueando fcm.googleapis.com', 'error');
                log('   - Proxy corporativo bloqueando', 'error');
                log('   - Sem conex√£o com internet', 'error');
                updateStatus('‚ùå FCM n√£o est√° acess√≠vel', 'error');
            }

            // Testar permiss√£o de notifica√ß√µes
            log('üîê Permiss√£o de notifica√ß√µes:', 'info');
            log(`   Status: ${Notification.permission}`, 'info');

            if (Notification.permission === 'denied') {
                log('   ‚ö†Ô∏è  Permiss√£o foi NEGADA pelo usu√°rio', 'error');
                log('   üí° Solu√ß√£o: Altere nas configura√ß√µes do navegador', 'info');
            }
        }

        async function testDifferentKey() {
            log('üîë Testando com chave VAPID alternativa...', 'info');

            // Gerar uma nova chave VAPID de teste
            const testKey = 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U';

            log('üîë Chave de teste: ' + testKey.substring(0, 30) + '...', 'info');

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            try {
                log('‚è≥ Aguardando Service Worker...', 'info');
                const registration = await navigator.serviceWorker.ready;

                if (!registration.active) {
                    log('‚ùå Service Worker n√£o est√° ativo', 'error');
                    return;
                }

                log('‚úÖ Service Worker ativo', 'success');

                // Solicitar permiss√£o
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    log('‚ùå Permiss√£o negada', 'error');
                    return;
                }

                log('üìù Tentando criar subscri√ß√£o com chave de teste...', 'info');

                const applicationServerKey = urlBase64ToUint8Array(testKey);
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                log('‚úÖ SUCESSO! Subscri√ß√£o criada com chave de teste!', 'success');
                log('   Endpoint: ' + subscription.endpoint.substring(0, 50) + '...', 'info');
                updateStatus('‚úÖ Subscri√ß√£o funcionou com chave de teste!', 'success');

                // Desinscrever
                await subscription.unsubscribe();
                log('‚ÑπÔ∏è  Subscri√ß√£o de teste removida', 'info');

            } catch (error) {
                log(`‚ùå Erro ao criar subscri√ß√£o: ${error.name}`, 'error');
                log(`   Mensagem: ${error.message}`, 'error');

                if (error.name === 'AbortError') {
                    log('', 'error');
                    log('üö® DIAGN√ìSTICO:', 'error');
                    log('', 'error');
                    log('Este erro "AbortError: Registration failed - push service error"', 'error');
                    log('normalmente indica um dos seguintes problemas:', 'error');
                    log('', 'info');
                    log('1Ô∏è‚É£  FIREWALL/PROXY bloqueando fcm.googleapis.com', 'info');
                    log('2Ô∏è‚É£  NAVEGADOR em modo que n√£o suporta push (modo privado extremo)', 'info');
                    log('3Ô∏è‚É£  SISTEMA OPERACIONAL bloqueando notifica√ß√µes', 'info');
                    log('4Ô∏è‚É£  VPN/REDE corporativa bloqueando servi√ßos Google', 'info');
                    log('', 'info');
                    log('üí° SOLU√á√ïES POSS√çVEIS:', 'success');
                    log('', 'success');
                    log('‚úÖ Teste em outro navegador (Chrome, Firefox, Edge)', 'success');
                    log('‚úÖ Desabilite VPN/Proxy temporariamente', 'success');
                    log('‚úÖ Teste em outra rede (4G, hotspot do celular)', 'success');
                    log('‚úÖ Verifique firewall do sistema operacional', 'success');
                    log('‚úÖ Teste em modo an√¥nimo/privado do navegador', 'success');
                }

                updateStatus('‚ùå Erro ao criar subscri√ß√£o', 'error');
            }
        }

        // Executar testes automaticamente
        window.addEventListener('load', () => {
            testBrowserSupport();
            setTimeout(() => testFCMConnectivity(), 1000);
        });
    </script>
</body>
</html>
